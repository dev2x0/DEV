name: Windows RDP with Ngrok (Free)

on:
  push:
    branches: [ main ]

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 600
    steps:
      - name: Enable Remote Desktop
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      - name: Download Ngrok
        run: |
          Invoke-WebRequest -Uri https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath $env:USERPROFILE
      - name: Start Ngrok Tunnel and Output RDP Connection Address
        run: |
          $ngrokPath = Join-Path $env:USERPROFILE -ChildPath "ngrok.exe"
          $ngrokOutput = Start-Process -FilePath $ngrokPath -ArgumentList "authtoken ${{ secrets.NGROK_AUTH_TOKEN }} tcp 3389" -NoNewWindow -PassThru
          $ngrokUrl = ($ngrokOutput.StandardOutput | Select-String -Pattern "tcp://.*:[0-9]+" | Select-Object -First 1).Matches.Value
          $rdpAddress = $ngrokUrl -replace "tcp://", ""
          Write-Output "RDP connection address: $rdpAddress"
